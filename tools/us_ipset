// Clash Verge - å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆScriptï¼‰
// ç›®æ ‡ï¼šVSCode + Python èµ° â€œæœºåœºèŠ‚ç‚¹(ç¬¬ä¸€è·³) -> ç¾å›½é™æ€IP(ç¬¬äºŒè·³)â€ï¼›å…¶å®ƒè½¯ä»¶ä»æŒ‰åŸ rules

function main(config) {
  // ========= â‘  åªéœ€è¦æ”¹è¿™é‡Œï¼šä½ çš„ç¾å›½é™æ€IP =========
  const staticProxy = {
    name: "ğŸ‡ºğŸ‡¸ ç¾å›½é™æ€IP",
    type: "socks5",        // å¦‚æœå•†å®¶ç»™çš„æ˜¯ httpï¼Œå°±æ”¹æˆ "http"
    server: "1.2.3.4",     // æ”¹æˆä½ çš„IP
    port: 12345,           // æ”¹æˆç«¯å£
    username: "user",      // æ²¡æœ‰ç”¨æˆ·åå¯†ç å°±åˆ æ‰ username/password ä¸¤è¡Œ
    password: "pass",
    udp: true
  };

  // ä½ æ–‡ä»¶é‡Œçš„æœºåœºé€‰æ‹©ç»„åå°±æ˜¯è¿™ä¸ªï¼šğŸ”° é€‰æ‹©èŠ‚ç‚¹  :contentReference[oaicite:1]{index=1}
  const airportGroupName = "ğŸ”° é€‰æ‹©èŠ‚ç‚¹";
  // ===============================================

  const finalGroupName = "â›“ï¸ VSCode+Python é™æ€é“¾";
  const relayPrefix = "â›“ï¸ chain/";

  const isArr = (x) => Array.isArray(x);

  function upsertByName(arr, obj) {
    if (!isArr(arr)) arr = [];
    const i = arr.findIndex((x) => x && x.name === obj.name);
    if (i >= 0) arr[i] = obj;
    else arr.push(obj);
    return arr;
  }

  function removeGroupsByPredicate(groups, pred) {
    if (!isArr(groups)) return [];
    return groups.filter((g) => g && !pred(g));
  }

  function removeRulesExact(rules, list) {
    if (!isArr(rules)) return [];
    const s = new Set(list);
    return rules.filter((r) => !s.has(r));
  }

  function cleanName(s) {
    return String(s || "").replace(/\s+/g, " ").trim();
  }

  // 0) åˆå§‹åŒ–
  if (!config) config = {};
  if (!isArr(config.proxies)) config.proxies = [];
  if (!isArr(config["proxy-groups"])) config["proxy-groups"] = [];
  if (!isArr(config.rules)) config.rules = [];

  // 1) åŠ å…¥/æ›´æ–°ä½ çš„ç¾å›½é™æ€IPåˆ° proxies
  config.proxies = upsertByName(config.proxies, staticProxy);

  // 2) æ‰¾åˆ°æœºåœºé€‰æ‹©ç»„
  const airportGroup = config["proxy-groups"].find((g) => g && g.name === airportGroupName);
  if (!airportGroup || !isArr(airportGroup.proxies) || airportGroup.proxies.length === 0) {
    // æ‰¾ä¸åˆ°å°±ä¸æ”¹ï¼Œé¿å…ç ´åé…ç½®
    return config;
  }

  // 3) ä»æœºåœºç»„é‡Œæ‹¿â€œç¬¬ä¸€è·³å€™é€‰èŠ‚ç‚¹â€
  // ä½ çš„æœºåœºç»„é‡Œæœ‰ DIRECTï¼ˆæ–‡ä»¶é‡Œèƒ½çœ‹åˆ°ï¼‰:contentReference[oaicite:2]{index=2}
  // è¿™é‡Œä¼šæŠŠ DIRECT/REJECT æ’é™¤æ‰
  const firstHopNodes = airportGroup.proxies
    .filter((p) => typeof p === "string" && p.length > 0)
    .filter((p) => {
      const x = p.toUpperCase();
      return x !== "DIRECT" && x !== "REJECT" && x !== "REJECT-DROP";
    });

  // 4) ä¸ºæ¯ä¸ªç¬¬ä¸€è·³èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ª relayï¼š (è¯¥èŠ‚ç‚¹ -> ç¾å›½é™æ€IP)
  const relayGroups = [];
  const relayNames = [];

  for (const hop of firstHopNodes) {
    const hopName = cleanName(hop);
    const relayName = cleanName(`${relayPrefix}${hopName}`);
    relayGroups.push({
      name: relayName,
      type: "relay",
      proxies: [hopName, staticProxy.name]
    });
    relayNames.push(relayName);
  }

  // 5) æœ€ç»ˆç»™ VSCode/Python ç”¨çš„ç»„ï¼šselectï¼ˆé€‰æ‹©å“ªæ¡é“¾=é€‰æ‹©ç¬¬ä¸€è·³ï¼‰
  const finalGroup = {
    name: finalGroupName,
    type: "select",
    proxies: [
      ...relayNames,
      airportGroupName,   // å¤‡ç”¨ï¼šç›´æ¥èµ°æœºåœºï¼ˆä¸å¥—é™æ€IPï¼‰
      staticProxy.name    // å¤‡ç”¨ï¼šç›´è¿é™æ€IPï¼ˆæ’éšœç”¨ï¼Œä¸å»ºè®®å¸¸ç”¨ï¼‰
    ]
  };

  // 6) æ¸…ç†æ—§çš„åŒåç»„ & æ—§çš„ relayPrefix ç»„ï¼Œé¿å…è®¢é˜…æ›´æ–°åè¶Šå è¶Šå¤š
  config["proxy-groups"] = removeGroupsByPredicate(
    config["proxy-groups"],
    (g) => g.name === finalGroupName || String(g.name || "").startsWith(relayPrefix)
  );

  // æŠŠæ–°ç»„æ”¾å‰é¢ï¼ŒUIé‡Œå¥½æ‰¾
  config["proxy-groups"].unshift(finalGroup, ...relayGroups);

  // 7) åªç»™ VSCode + Python æ’å…¥è¿›ç¨‹è§„åˆ™ï¼ˆæ’åˆ° rules æœ€å‰é¢ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
  const myRules = [
    `PROCESS-NAME,code.exe,${finalGroupName}`,
    `PROCESS-NAME,Code.exe,${finalGroupName}`,
    `PROCESS-NAME,python.exe,${finalGroupName}`,
    `PROCESS-NAME,pythonw.exe,${finalGroupName}`
  ];

  config.rules = removeRulesExact(config.rules, myRules);
  config.rules.unshift(...myRules);

  return config;
}
